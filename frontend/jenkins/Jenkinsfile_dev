pipeline {
    agent any

    environment {
        CONTAINER_NAME = 'frontend-dev'
        HOST_PORT = '3001'
        IMAGE_NAME = 'frontend-dev-image'
        NODE_ENV = 'production'
        NEXT_PUBLIC_API_BASE_URL = 'dev-api.shaunthesheep.store'
    }

    tools {
        nodejs 'node-18'
    }

    stages {
        stage('Install Dependencies') {
            steps {
                dir("frontend") {
                    sh 'rm -rf node_modules package-lock.json'
                    sh 'npm install'
                    sh 'npm run build'
                }
            }
        }
        stage('Build') {
            steps {
                dir("frontend") {
                    sh 'npm run build'
                }
            }
        }
        stage('Build Docker Image') {
            steps {
                dir('frontend') {
                    sh "docker build -t $IMAGE_NAME:latest ."
                }
            }
        }
        stage('Stop Old Container') {
            steps {
                sh "docker rm -f $CONTAINER_NAME || true"
            }
        }
        stage('Remove Old Image') {
            steps {
                sh "docker rmi $IMAGE_NAME:latest || true"
            }
        }
        stage('Run New Container') {
            steps {
                sh """
                docker run -d --name $CONTAINER_NAME \
                    -e NODE_ENV=$NODE_ENV \
                    -e NEXT_PUBLIC_API_BASE_URL=$NEXT_PUBLIC_API_BASE_URL \
                    -p $HOST_PORT:3000 \
                    $IMAGE_NAME:latest
                """
            }
        }
        stage('Cleanup Old Images') {
            steps {
                sh 'docker image prune -f'
            }
        }
    }
}
